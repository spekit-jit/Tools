<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tiny Tools Â· Staging</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{--bg:#0f1220;--panel:#14182a;--ink:#e9ecf8;--muted:#9aa3bf;--radius:16px;--shadow:0 16px 40px rgba(0,0,0,.38);--font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
  @media (prefers-color-scheme: light){:root{--bg:#f6f7fb;--panel:#fff;--ink:#0f1426;--muted:#596486;--shadow:0 18px 40px rgba(12,24,60,.08)}}
  *{box-sizing:border-box}
  body{margin:0;font-family:var(--font);color:var(--ink);background:
    radial-gradient(1200px 520px at 0% -10%, rgba(110,86,207,.25), transparent 60%),
    radial-gradient(900px 360px at 110% 0%, rgba(69,231,179,.20), transparent 60%),
    var(--bg)}
  header{padding:24px 18px;border-bottom:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg, rgba(255,255,255,.03), transparent)}
  .wrap{max-width:980px;margin:0 auto;padding:0 14px}
  h1{margin:0 0 6px;font-size:22px;letter-spacing:.2px}
  .sub{margin:0;color:var(--muted);font-size:13px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:transparent;color:var(--ink);font-weight:600;cursor:pointer}
  main{padding:22px}
  .board{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:var(--shadow);padding:18px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  @media (max-width:880px){.grid{grid-template-columns:repeat(8,1fr)}}
  @media (max-width:600px){.grid{grid-template-columns:repeat(2,1fr)}}
  a.tool{
    grid-column:span 3;display:inline-flex;align-items:center;justify-content:center;
    text-decoration:none;text-align:center;padding:14px 12px;min-height:56px;border-radius:14px;
    color:#fff;font-weight:700;letter-spacing:.2px;border:1px solid rgba(255,255,255,.12);
    box-shadow:0 12px 26px rgba(0,0,0,.25);transition:transform .06s,box-shadow .12s;word-break:break-word;backdrop-filter:saturate(110%)
  }
  @media (max-width:880px){a.tool{grid-column:span 4}}
  @media (max-width:600px){a.tool{grid-column:span 2}}
  a.tool:hover{transform:translateY(-1px);box-shadow:0 14px 30px rgba(0,0,0,.3)}
  .empty{margin-top:10px;padding:14px;border:1px dashed rgba(255,255,255,.18);border-radius:12px;color:var(--muted);text-align:center}
  .status{margin-top:10px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Tiny Tools Â· Staging</h1>
    <div class="sub">
      Buttons for each <code>.html</code> in <code>/tools</code>. Opens in a new tab.
      <button id="refresh" class="btn">â†» Refresh</button>
      <span id="status" class="status"></span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="board">
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">No <code>.html</code> files found in <code>/tools</code>.</div>
  </div>
</main>

<script>
const grid = document.getElementById("grid");
const empty = document.getElementById("empty");
const statusEl = document.getElementById("status");
document.getElementById("refresh").addEventListener("click", ()=> boot(true));

/* --- repo detection for user site (https://spekit-jit.github.io/tools) --- */
function parseOwnerRepo(){
  const owner = location.hostname.split(".")[0]; // "spekit-jit"
  const userRepo = `${owner}.github.io`;         // "spekit-jit.github.io"
  const parts = location.pathname.split("/").filter(Boolean); // ["tools"]
  const repo = (parts.length===0 || parts[0]==="tools") ? userRepo : parts[0];
  return { owner, repo };
}

/* --- url helpers --- */
function toHref(rel){
  const base = location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/\/[^\/]*$/, '/');
  return new URL(rel, location.origin + base).toString();
}

/* --- look/feel --- */
function hash(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
function hueFromName(name){ return (hash(name) % 360); }
function emojiFor(name){
  const emojis=["âœ¨","ðŸš€","ðŸ§©","ðŸ› ï¸","âš¡","ðŸ“Š","ðŸ§ ","ðŸ“Ž","ðŸŽ¯","ðŸ§ª","ðŸ“","ðŸ—‚ï¸","ðŸ”§","ðŸ“","ðŸ§­","ðŸ’¡","ðŸª„","ðŸ”—","ðŸ–‡ï¸","ðŸ“Œ"];
  return emojis[ hash(name) % emojis.length ];
}
function stripHtmlExt(s){ return s.replace(/\.html?$/i,''); }

function buttonFor(fileName){
  const hue=hueFromName(fileName);
  const bg1=`hsl(${hue} 75% 46%)`, bg2=`hsl(${(hue+24)%360} 78% 44%)`;
  const a=document.createElement("a");
  a.className="tool"; a.href=toHref(fileName); a.target="_blank"; a.rel="noopener";
  a.style.background=`linear-gradient(180deg, ${bg1}, ${bg2})`;
  a.textContent = stripHtmlExt(fileName) + " " + emojiFor(fileName);
  a.title = fileName;
  return a;
}

function render(files, sourceLabel){
  grid.innerHTML="";
  const htmlFiles = files
    .filter(n=>/\.html?$/i.test(n))
    .filter(n=>!/^index\.html?$/i.test(n)); // skip this page itself
  if(!htmlFiles.length){ empty.style.display="block"; statusEl.textContent = `0 files (${sourceLabel})`; return; }
  empty.style.display="none";
  htmlFiles.sort((a,b)=>a.localeCompare(b)).forEach(n=>grid.appendChild(buttonFor(n)));
  statusEl.textContent = `Loaded ${htmlFiles.length} file(s) from ${sourceLabel}).`;
}

/* --- data sources --- */
async function listViaManifest(){
  const paths = ["./tools.json"]; // kept simple; GitHub Action keeps it fresh
  for(const p of paths){
    try{
      const res = await fetch(p, {cache:"no-store"});
      if(!res.ok) continue;
      const arr = await res.json();
      const list = arr.map(x => typeof x==="string" ? x : x.path).filter(Boolean);
      if(list.length) return {list, source:`manifest (${p})`};
    }catch(e){}
  }
  return null;
}
async function listViaGitHubAPI(){
  const {owner, repo} = parseOwnerRepo();
  const api = `https://api.github.com/repos/${owner}/${repo}/contents/tools`;
  const res = await fetch(api, {cache:"no-store"});
  if(!res.ok) throw new Error(res.status+" "+res.statusText);
  const data = await res.json();
  return { list: data.filter(x=>x.type==="file").map(x=>x.name), source:"GitHub API" };
}

/* --- boot & polling --- */
let pollHandle = null;
async function boot(force=false){
  if(force && pollHandle){ clearInterval(pollHandle); pollHandle = null; }
  // 1) manifest-first (kept in sync by Action), 2) API fallback
  let files, source;
  const mf = await listViaManifest();
  if(mf){ files = mf.list; source = mf.source; }
  if(!files){
    try{ const api = await listViaGitHubAPI(); files = api.list; source = api.source; }
    catch(e){ files = []; source = "none (API error & no manifest)"; }
  }
  render(files || [], source);
  // light polling
  if(!pollHandle){ pollHandle = setInterval(async ()=>{ boot(true); }, 90000); } // 90s
}
boot();
</script>
</body>
</html>
